{% extends 'base.html.twig' %}
{% block style %}
    {{ parent() }}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>

    <style>
        #mapid{
            min-height: 550px;
        }
    </style>
{% endblock %}

{% block body %}
    <section class="container mt-5">
        <div class="row">

            <aside class="col-lg-6">
                <div id="mapid" class="map-container z-depth-1-half"></div>
                <p class="text-muted">Cliquez sur la map pour avoir votre <strong>longitude</strong> et votre <strong>latitude</strong>.</p>
            </aside >

            <aside class="col-lg-6 mt-5 mt-lg-0">
                {{ form_start(observationForm) }}
                    <h2 class="mb-4 text-sm-center text-lg-left">Observation</h2>

                    <div class="form-group">
                        {{ form_label(observationForm.species, 'Espèce', {'label_attr':{'class':'grey-text'}}) }}
                        {{ form_widget(observationForm.species, {'attr':{'class':'form-control'}}) }}
                    </div>

                    <div class="form-group">
                        {{ form_label(observationForm.description, 'Description de votre observation',
                            {'label_attr':{'class':'grey-text'}}) }}
                        {{ form_widget(observationForm.description, {'attr':{'class':'form-control','rows':3}}) }}
                    </div>

                    <hr>

                    <div class="row">
                        <div class="form-group col-6">
                            {{ form_label(observationForm.position.latitude, 'Latitude',
                                {'label_attr':{'class':'grey-text'}}) }}
                            {{ form_widget(observationForm.position.latitude, {'attr':{'class':'form-control'}}) }}
                        </div>

                        <div class="form-group col-6">
                            {{ form_label(observationForm.position.longitude, 'Longitude',
                                {'label_attr':{'class':'grey-text'}}) }}
                            {{ form_widget(observationForm.position.longitude, {'attr':{'class':'form-control'}}) }}
                        </div>

                        <div class="form-group col-12">
                            <a class="btn btn-outline-info col-12" id="localisation" >
                                Appuyer pour être localisé par GPS<i class="fa fa-map-marker ml-2"></i>
                            </a>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="custom-file">
                            {{ form_label(observationForm.image, 'Image d\'un oiseau',
                                {'label_attr':{'class':'custom-file-label'}}) }}
                            {{ form_widget(observationForm.image, {'attr':{'class':'ustom-file-input'}}) }}
                        </div>
                    </div>

                    <hr>

                    <div class="form-group text-right">
                        <button class="col-6 btn btn-success" type="submit">Envoyer<i class="fa fa-paper-plane-o ml-2"></i></button>
                    </div>

                {{ form_end(observationForm) }}
                <!-- Default form contact -->
            </aside>
        </div>
    </section>

    <!-- JQuery-ui -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>

{% endblock %}

{% block script %}
    {{ parent() }}
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin="">
    </script>
    <!-- JQuery -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
   <!-- Leaflet JS var -->
    <script>
        $(document).ready(function(){

            // initialisation de la map + position de la map
            var mymap = L.map('mapid').setView([48.857342405041436, 2.3520934581756596], 6);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 8,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoiZnJvc3RlIiwiYSI6ImNqaDd3OHdtbzAwbm0ycXFsbmFtOTJidTIifQ.C6l9gAch8EEE5fxzCIF35g'
            }).addTo(mymap);

            var marker;
            // fonction click sur la map pour donner la position du clic et remplit lat et long dans form
            function onMapClick(e) {
                if (typeof (marker)==='undefined') {
                    marker = new L.marker(e.latlng);
                    marker.addTo(mymap)
                        .bindPopup("Votre latitude et votre longitude a été renseigné en fonction de l'endroit ou vous venez de cliquer (" + e.latlng + ")").openPopup();
                }else {
                    marker.setLatLng(e.latlng)
                        .bindPopup("Votre latitude et votre longitude a été renseigné en fonction de l'endroit ou vous venez de cliquer (" + e.latlng + ")").openPopup();
                }
                $("#lat").val(e.latlng.lat); // a remplacer par l'id du champ latitude
                $("#long").val(e.latlng.lng); // a remplacer par l'id du champ longitude
            }

            // si localisation OK donne lat et long avec marker et remplit lat et long dans form
            function onLactionFound(e){
                if (typeof (marker)==='undefined') {
                    marker = new L.marker(e.latlng);
                    marker.addTo(mymap)
                        .bindPopup("Votre latitude et votre longitude a été renseigné en fonction de votre emplacement GPS (" + e.latlng + ")").openPopup();
                }else {
                    marker.setLatLng(e.latlng)
                        .bindPopup("Votre latitude et votre longitude a été renseigné en fonction de votre emplacement GPS (" + e.latlng + ")").openPopup();
                }
                $("#observation_position_latitude").val(e.latlng.lat); // a remplacer par l'id du champ latitude
                $("#observation_position_longitude").val(e.latlng.lng); // a remplacer par l'id du champ longitude
            }

            // Message d'erreur de l'ocalisation
            function onLocationError(e) {
                alert(e.message);
            }

            // service de localisation
            $("#localisation").click(function(){
                mymap.locate({setView: true, maxZoom: 16});
            });

            mymap.on('click', onMapClick);
            mymap.on('locationfound', onLactionFound);
            mymap.on('locationerror', onLocationError);
        });
    </script>

    <script>
        $(document).ready(function() {
        $("#observation_species")
            .val("")
            .autocomplete({
                source: "{{ path('species_autocomplete') }}",
                minLength: 2,
            });
       });
    </script>
{% endblock %}
